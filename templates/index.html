<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Torrent & NFO Creator</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="container">
    <h1>Torrent & NFO Creator</h1>

    <div class="grid">
      <div class="panel">
        <h2>Browse</h2>
        <div id="path" class="path"></div>
        
        <!-- NEW SEARCH BAR -->
        <div class="search-container">
          <input type="text" id="search" placeholder="ðŸ” Search files..." />
          <button id="clear-search" style="display:none;">âœ•</button>
        </div>
        
        <div id="list" class="list"></div>
      </div>

      <div class="panel">
        <h2>Create</h2>
        <div class="row">
          <label>Selected file</label>
          <div id="selected" class="mono">(none)</div>
        </div>
        <div class="row">
          <label>Tracker URL</label>
          <input id="tracker" type="text" placeholder="https://tracker.example/announce" value="{{ config.TRACKER_URL }}" />
        </div>
        <div class="row">
          <label>Piece size (KB, 0=auto)</label>
          <input id="piece" type="number" min="0" value="{{ config.PIECE_SIZE }}" />
        </div>
        <div class="row inline">
          <label><input id="private" type="checkbox" {% if config.PRIVATE_TORRENT %}checked{% endif %}/> Private</label>
          <label><input id="hardlink" type="checkbox" {% if config.AUTO_HARDLINK %}checked{% endif %}/> Hardlink</label>
        </div>
        <button id="go">Create</button>

        <h2>Log</h2>
        <pre id="log" class="log"></pre>
      </div>
    </div>
  </div>

<script>
let currentPath = '{{ config.MEDIA_PATH }}';
let selectedFile = null;
let allItems = []; // Store all items for filtering

function log(msg){
  const el = document.getElementById('log');
  el.textContent += msg + "\n";
  el.scrollTop = el.scrollHeight;
}

function filterItems(query) {
  const list = document.getElementById('list');
  const items = list.querySelectorAll('.item');
  let visibleCount = 0;
  
  items.forEach(item => {
    const text = item.textContent.toLowerCase();
    const matches = text.includes(query.toLowerCase());
    item.style.display = matches ? 'block' : 'none';
    if (matches) visibleCount++;
  });
  
  // Show clear button if there's a search query
  document.getElementById('clear-search').style.display = query ? 'inline-block' : 'none';
}

function render(data){
  document.getElementById('path').textContent = data.current_path;
  const list = document.getElementById('list');
  list.innerHTML = '';
  allItems = data.items;

  if (data.parent_path) {
    const up = document.createElement('div');
    up.className = 'item dir parent-dir';
    up.textContent = 'ðŸ“ ..';
    up.onclick = () => {
      document.getElementById('search').value = '';
      load(data.parent_path);
    };
    list.appendChild(up);
  }

  data.items.forEach(it => {
    const d = document.createElement('div');
    d.className = 'item ' + (it.type === 'directory' ? 'dir' : 'file');
    
    if (it.type === 'directory') {
      d.textContent = 'ðŸ“ ' + it.name;
      d.onclick = () => {
        document.getElementById('search').value = '';
        load(it.path);
      };
    } else {
      const size = (it.size / (1024 * 1024 * 1024)).toFixed(2);
      d.innerHTML = `ðŸŽ¬ ${it.name} <span class="size">(${size} GB)</span>`;
      d.onclick = () => {
        selectedFile = it.path;
        document.getElementById('selected').textContent = it.path;
        document.querySelectorAll('.item.file').forEach(x => x.classList.remove('sel'));
        d.classList.add('sel');
      };
    }
    
    list.appendChild(d);
  });
  
  // Apply search filter if there's a query
  const searchQuery = document.getElementById('search').value;
  if (searchQuery) {
    filterItems(searchQuery);
  }
}

function load(path){
  fetch('/browse?path=' + encodeURIComponent(path))
    .then(r => r.json())
    .then(d => { currentPath = d.current_path; render(d); })
    .catch(e => log('Browse error: ' + e));
}

// Search functionality
document.getElementById('search').addEventListener('input', (e) => {
  filterItems(e.target.value);
});

document.getElementById('search').addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    e.target.value = '';
    filterItems('');
  }
});

document.getElementById('clear-search').addEventListener('click', () => {
  document.getElementById('search').value = '';
  filterItems('');
  document.getElementById('search').focus();
});

// Create torrent functionality
document.getElementById('go').onclick = () => {
  if (!selectedFile) return log('Select a video file first.');
  const payload = {
    video_path: selectedFile,
    tracker_url: document.getElementById('tracker').value,
    piece_size: parseInt(document.getElementById('piece').value || '0'),
    private: document.getElementById('private').checked,
    create_hardlink: document.getElementById('hardlink').checked
  };
  log('Creating...');
  fetch('/create', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)})
    .then(r => r.json().then(j => ({ok:r.ok, j})))
    .then(({ok, j}) => {
      if (!ok) { log('Error: ' + (j.error || JSON.stringify(j))); return; }
      log('NFO: ' + (j.results.nfo.path || 'failed'));
      log('TORRENT: ' + (j.results.torrent.path || 'failed'));
      if (j.results.hardlink) log('HARDLINK: ' + (j.results.hardlink.target || 'failed'));
      log('Done.');
    })
    .catch(e => log('Create error: ' + e));
};

load(currentPath);
</script>
</body>
</html>
